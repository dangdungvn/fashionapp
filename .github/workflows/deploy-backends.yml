name: Deploy to Azure VM

on:
  workflow_dispatch:
    inputs:
      deploy_python:
        description: "Deploy Python backend"
        required: true
        default: true
        type: boolean
      deploy_node:
        description: "Deploy Node.js payment backend"
        required: true
        default: true
        type: boolean

jobs:
  deploy:
    name: Deploy to Azure VM
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v3

      - name: Connect to Azure VM and deploy
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.AZURE_VM_HOST }}
          username: ${{ secrets.AZURE_VM_USERNAME }}
          key: ${{ secrets.AZURE_VM_SSH_KEY }}
          port: ${{ secrets.AZURE_VM_PORT }}
          script: |
            echo "Connected to Azure VM. Starting deployment process..."

            # Đi đến thư mục chứa repository
            cd ${{ secrets.PROJECT_PATH }}

            # Pull code mới từ GitHub
            git pull            # Deploy Python Backend (nếu được chọn)
            if [[ "${{ github.event.inputs.deploy_python == 'true' }}" == "true" ]]; then
              echo "Deploying Python backend..."
              cd ${{ secrets.PROJECT_PATH }}/pybackend
              
              # Cài đặt dependencies nếu có thay đổi trong requirements.txt
              if git diff --name-only HEAD^ HEAD | grep -q "pybackend/requirements.txt"; then
                echo "Installing Python dependencies..."
                pip install -r requirements.txt
              fi
              
              # Restart Python backend
              echo "Restarting Python backend..."
              python run_azure_server.py --action restart --server uvicorn
              
              echo "Python backend deployed successfully."
            fi            # Deploy Node.js Payment Backend (nếu được chọn)
            if [[ "${{ github.event.inputs.deploy_node == 'true' }}" == "true" ]]; then
              echo "Deploying Node.js payment backend..."
              cd ${{ secrets.PROJECT_PATH }}/fashion_payment
              
              # Cài đặt dependencies nếu có thay đổi trong package.json
              if git diff --name-only HEAD^ HEAD | grep -q "fashion_payment/package.json"; then
                echo "Installing Node.js dependencies..."
                npm install
              fi
              
              # Restart Node.js payment backend
              echo "Restarting Node.js payment backend..."
              node run_azure_server.js restart
              
              echo "Node.js payment backend deployed successfully."
            fi

            echo "Deployment completed successfully."
